name: Train and Release Model

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      version:
        description: 'Model version (e.g., v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes'
        required: false
        type: string
        default: 'New model release'

jobs:
  train-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.9'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download NLTK data
        run: |
          python -c "import nltk; nltk.download('stopwords')"
      
      - name: Create output directory
        run: mkdir -p output
      
      - name: Download training data
        run: |
          echo "=========================================="
          echo "Step 1/4: Downloading SMS dataset"
          echo "=========================================="
          python src/get_data.py
          
          echo ""
          echo "Verifying downloaded data..."
          if [ -f "smsspamcollection/SMSSpamCollection" ]; then
            echo "✓ Data downloaded successfully"
            wc -l smsspamcollection/SMSSpamCollection
          else
            echo "✗ Data download failed!"
            exit 1
          fi
      
      - name: Preprocess data
        run: |
          echo "" 
          echo "=========================================="
          echo "Step 2/4: Preprocessing text data"
          echo "=========================================="
          python src/text_preprocessing.py
          
          echo ""
          echo "Verifying preprocessor..."
          if [ -f "output/preprocessor.joblib" ]; then
            echo "✓ Preprocessor created successfully"
            ls -lh output/preprocessor.joblib
          else
            echo "✗ Preprocessing failed!"
            exit 1
          fi
      
      - name: Train classifier
        run: |
          echo ""
          echo "=========================================="
          echo "Step 3/4: Training classifier"
          echo "=========================================="
          python src/text_classification.py
          
          echo ""
          echo "Verifying trained model..."
          if [ -f "output/model.joblib" ]; then
            echo "✓ Model trained successfully"
            ls -lh output/model.joblib
          else
            echo "✗ Model training failed!"
            exit 1
          fi
      
      - name: Verify model files
        run: |
          echo ""
          echo "=========================================="
          echo "Step 4/4: Verifying all artifacts"
          echo "=========================================="
          echo ""
          echo "Required files:"
          ls -lh output/model.joblib output/preprocessor.joblib
          
          echo ""
          echo "Additional artifacts created:"
          ls -lh output/
          
          # Verify the model can be loaded
          python -c "
          import joblib
          print('Testing model loading...')
          model = joblib.load('output/model.joblib')
          print('✓ Model loaded successfully')
          preprocessor = joblib.load('output/preprocessor.joblib')
          print('✓ Preprocessor loaded successfully')
          
          # Test prediction
          test_msg = ['Free entry in 2 a wkly comp to win FA Cup']
          processed = preprocessor.transform(test_msg)
          prediction = model.predict(processed)[0]
          print(f'✓ Test prediction: {prediction}')
          "
      
      - name: Create model metadata
        run: |
          cat > output/model_metadata.json << EOF
          {
            "version": "${{ inputs.version }}",
            "trained_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "python_version": "$(python --version | cut -d' ' -f2)",
            "sklearn_version": "$(python -c 'import sklearn; print(sklearn.__version__)')",
            "model_files": [
              "model.joblib",
              "preprocessor.joblib"
            ],
            "classifier": "Decision Tree",
            "workflow_run": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}"
          }
          EOF
          
          echo ""
          echo "Model metadata:"
          cat output/model_metadata.json
      
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo ""
          echo "=========================================="
          echo "Creating GitHub Release"
          echo "=========================================="
          
          # Create release with model files
          gh release create "${{ inputs.version }}" \
            --title "Model Release ${{ inputs.version }}" \
            --notes "${{ inputs.release_notes }}" \
            output/model.joblib \
            output/preprocessor.joblib \
            output/model_metadata.json
          
          echo ""
          echo "✓ Release created successfully!"
          echo ""
          echo "Models are now publicly accessible at:"
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ inputs.version }}"
          echo ""
          echo "Download URLs:"
          echo "  - Model: https://github.com/${{ github.repository }}/releases/download/${{ inputs.version }}/model.joblib"
          echo "  - Preprocessor: https://github.com/${{ github.repository }}/releases/download/${{ inputs.version }}/preprocessor.joblib"
      
      - name: Upload artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: trained-models-${{ inputs.version }}
          path: |
            output/model.joblib
            output/preprocessor.joblib
            output/model_metadata.json
          retention-days: 90
